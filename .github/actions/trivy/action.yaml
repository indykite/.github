#
# DO NOT EDIT!!!
# Managed by GitHub Action and synced from a private repo!
#
---
name: trivy
description: Runs Trivy vulnerability scanner
inputs:
  github_token:
    description: GitHub token for uploading artifacts
    required: true
runs:
  using: composite
  steps:
    - name: actions/checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
    - name: setup/oras
      uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6
    - name: get date
      id: date
      shell: bash
      run: echo "date=$(date +'%Y%m%d')" >> "$GITHUB_OUTPUT"
    - name: actions/cache
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
      id: cache
      with:
        path: ${{ github.workspace }}/.cache/trivy
        key: cache-trivy-${{ steps.date.outputs.date }}
    - name: trivy-db
      if: (!steps.cache.outputs.cache-hit)
      shell: bash
      run: |
        mkdir -p "$GITHUB_WORKSPACE/.cache/trivy/db"
        oras pull ghcr.io/aquasecurity/trivy-db:2
        tar -xzf db.tar.gz -C "$GITHUB_WORKSPACE/.cache/trivy/db"
        rm db.tar.gz
    - name: actions/cache/save
      uses: actions/cache/save@0400d5f644dc74513175e3cd8d07132dd4860809
      if: (!steps.cache.outputs.cache-hit)
      with:
        path: ${{ github.workspace }}/.cache/trivy
        key: cache-trivy-${{ steps.date.outputs.date }}
    - name: trivy
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
      with:
        scan-type: 'fs'
        scan-ref: '.'
        trivy-config: .trivy.yaml
        format: 'github'
        output: 'dependency-results.sbom.json'
        github-pat: ${{ inputs.github_token }}
