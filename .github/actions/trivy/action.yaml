---
#
# DO NOT EDIT!!!
# Managed by GitHub Actions
#
name: trivy
description: Runs Trivy vulnerability scanner
inputs:
  github_token:
    description: GitHub token for uploading artifacts
    required: true
runs:
  using: composite
  steps:
    - name: actions/checkout
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1 - https://github.com/actions/checkout/releases
    - name: setup/oras
      uses: oras-project/setup-oras@22ce207df3b08e061f537244349aac6ae1d214f6 # v1.2.4 - https://github.com/oras-project/setup-oras/releases
    - name: get date
      id: date
      shell: bash
      run: echo "date=$(date +'%Y%m%d')" >> "$GITHUB_OUTPUT"
    - name: actions/cache
      uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2 - https://github.com/actions/cache/releases
      id: cache
      with:
        # lookup-only: ${{ github.event_name != 'pull_request' }} # don't download on 'master'; if missing, will be saved anyway
        path: ${{ github.workspace }}/.cache/trivy
        key: cache-trivy-${{ steps.date.outputs.date }}
    - name: trivy-db
      if: (!steps.cache.outputs.cache-hit)
      shell: bash
      run: |
        mkdir -p "$GITHUB_WORKSPACE/.cache/trivy/db"
        oras pull ghcr.io/aquasecurity/trivy-db:2
        tar -xzf db.tar.gz -C "$GITHUB_WORKSPACE/.cache/trivy/db"
        rm db.tar.gz
    # - name: Download and extract the Java DB
    #   if: (!steps.cache.outputs.cache-hit)
    #   shell: bash
    #   run: |
    #     mkdir -p $GITHUB_WORKSPACE/.cache/trivy/java-db
    #     oras pull ghcr.io/aquasecurity/trivy-java-db:1
    #     tar -xzf javadb.tar.gz -C $GITHUB_WORKSPACE/.cache/trivy/java-db
    #     rm javadb.tar.gz
    - name: actions/cache/save
      uses: actions/cache/save@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2 - https://github.com/actions/cache/releases
      if: (!steps.cache.outputs.cache-hit)
      with:
        path: ${{ github.workspace }}/.cache/trivy
        key: cache-trivy-${{ steps.date.outputs.date }}
    - name: trivy # results in table format
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1 - https://github.com/aquasecurity/trivy-action/releases
      with:
        scan-type: 'fs'
        scan-ref: '.'
        trivy-config: .trivy.yaml
    # XXX: no option to do multiple formats in one scan, so doing separate runs
    - name: trivy/sbom # JSON SBOM format with uploading to GitHub Artifacts
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1 - https://github.com/aquasecurity/trivy-action/releases
      with:
        skip-setup-trivy: true
        scan-type: 'fs'
        scan-ref: '.'
        trivy-config: .trivy.yaml
        # format: 'sarif' - https://github.com/aquasecurity/trivy-action?tab=readme-ov-file#using-trivy-with-github-code-scanning
        # output: 'trivy-results.sarif'
        format: 'github'
        output: 'dependency-results.sbom.json'
        github-pat: ${{ inputs.github_token }}
